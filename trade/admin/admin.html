<html>
    <head>
        <title>Admin</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script type="module">
            import { getData, deleteOrder } from "/login/fetch.mjs";
            import { MAX_STOCK, QUANTITY_STEP } from '../robot/brain.mjs';
            import { confirmMarketOrder } from '../tda.mjs';
            import { renderOrders } from "./admin.mjs";

            let orders = null;
            const range = document.getElementById('range-quantity');
            const number = document.getElementById('number-quantity');

            window.onload = async () => {
                range.step = QUANTITY_STEP;
                range.min = QUANTITY_STEP;
                range.max = MAX_STOCK;
                number.step = QUANTITY_STEP;
                number.min = QUANTITY_STEP;
                number.max = MAX_STOCK;
                orders = await renderOrders();
            }

            window.deleteAll = async button => {
                button.disabled = true;
                await Promise.allSettled(orders.map(order => deleteOrder(order.savedOrderId)));
                window.location.reload();
            }

            window.updateQuantity = input => {
                if (input === range) {
                    number.value = input.value
                } else {
                    range.value = input.value
                }
            }

            window.placeOrder = async event => {
                event.preventDefault();
                const input = Object.fromEntries(new FormData(event.target));
                await confirmMarketOrder(input.order, input.symbol, input.quantity);
            }
        </script>
        <style>
            body {
                width: 100vw;
                height: 100vh;
            }
        </style>
    </head>
    <body>
        <header>
            <a href="/account/account.html">Account</a>
            <a href="/trade/trade.html">Trade</a>
        </header>
        <main>
            <br>
            <form onsubmit="placeOrder(event)">
                <select name="symbol">
                    <optgroup label="Cash">
                        <option>AAPL</option>
                    </optgroup>
                    <optgroup label="Margin">
                        <option selected>SQ</option>
                        <option>ABNB</option>
                    </optgroup>
                </select>
                <select name="order">
                    <optgroup label="Bear">
                        <option selected>Short</option>
                        <option>Cover</option>
                    </optgroup>
                    <optgroup label="Bull">
                        <option>Buy</option>
                        <option>Sell</option>
                    </optgroup>
                </select>
                <br><br>
                <input id="number-quantity" name="quantity" type="number" value="5" onchange="updateQuantity(this)">
                <input id="range-quantity" type="range" value="5" onchange="updateQuantity(this)">
                <br><br>
                <button type="submit">Submit</button>
            </form>
        </main>
        <footer>
            <ol></ol>
            <button onclick="deleteAll(this)">Delete All</button>
        </footer>
    </body>
</html>